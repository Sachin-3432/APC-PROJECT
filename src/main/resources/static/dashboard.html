<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinVista - Expense Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <div class="container">

        <div class="header">
            <h1><i class="fas fa-money-bill-wave"></i> FinVista</h1>
            <!-- Admin link (hidden by default) - dashboard.js will show this for users with ROLE_ADMIN -->
            <a id="admin-link" class="btn btn-link" href="/admin.html" style="display:none; margin-right:8px;">Admin</a>
            <div class="user-dropdown-container">
                <div class="notification-icon" id="notification-icon" onclick="toggleNotifications()"
                    style="margin-right: 15px; position: relative; cursor: pointer;">
                    <i class="fas fa-bell" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                    <span id="notification-badge" class="notification-badge"
                        style="display: none; position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">0</span>
                </div>
                <div class="user-info" id="user-info">
                    <img id="user-profile-img" src="https://ui-avatars.com/api/?name=User&background=2563eb&color=fff"
                        alt="Profile" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                    <span id="user-name-display">User</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="user-dropdown" class="user-dropdown">
                    <div class="dropdown-item" onclick="openProfileModal()"><i class="fas fa-user"></i> Profile</div>
                    <div class="dropdown-item" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Logout</div>
                </div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div id="notifications-panel" class="notifications-panel" style="display: none;">
            <div class="notifications-header">
                <h3><i class="fas fa-bell"></i> Notifications</h3>
                <button class="btn btn-small" onclick="markAllRemindersAsRead()">Mark All Read</button>
            </div>
            <div id="notifications-list" class="notifications-list">
                <div class="notification-item">Loading notifications...</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-receipt"></i> Total Expenses</h2>
                <p>‚Çπ <span id="total-expenses">0.00</span></p>
            </div>
            <div class="card">
                <h2><i class="fas fa-wallet"></i> Monthly Budget</h2>
                <div class="budget-edit">
                    <p>‚Çπ <span id="monthly-budget">5000.00</span></p>
                    <button class="btn btn-small" onclick="editBudget()"><i class="fas fa-edit"></i> Edit</button>
                </div>
                <form id="budget-form">
                    <input type="number" id="new-budget" placeholder="New Budget" step="0.01" required
                        class="budget-input">
                    <button type="submit" class="btn btn-small"><i class="fas fa-check"></i> Save</button>
                    <button type="button" class="btn btn-small btn-danger" onclick="cancelEditBudget()"><i
                            class="fas fa-times"></i> Cancel</button>
                </form>
            </div>
            <div class="card">
                <h2><i class="fas fa-piggy-bank"></i> Remaining Balance</h2>
                <p>‚Çπ <span id="remaining-balance">5000.00</span></p>
            </div>
        </div>

        <div class="group-section">
            <h2><i class="fas fa-users"></i> Expense Groups</h2>
            <div class="form-group">
                <label for="new-group">Create New Group</label>
                <input type="text" id="new-group" placeholder="Enter group name">
                <button class="btn" onclick="createGroup()"><i class="fas fa-plus"></i> Create Group</button>
            </div>
            <div class="form-group">
                <label for="join-group">Join Group by ID</label>
                <input type="text" id="join-group" placeholder="Enter group ID">
                <button class="btn" onclick="joinGroup()"><i class="fas fa-user-plus"></i> Join Group</button>
            </div>
            <div class="group-list" id="groups-list"></div>
        </div>

        <div class="expense-form">
            <h2><i class="fas fa-plus-circle"></i> Add New Expense</h2>
            <form id="expense-form">
                <input type="hidden" name="_csrf" id="csrf-token">
                <div class="form-group">
                    <label for="expense-group">Group</label>
                    <select id="expense-group">
                        <option value="">Select group (optional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-description">Description</label>
                    <input type="text" id="expense-description" placeholder="Enter description" required>
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount (‚Çπ)</label>
                    <input type="number" id="expense-amount" placeholder="Enter amount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <select id="expense-category" required>
                        <option value="food">Food</option>
                        <option value="transport">Transport</option>
                        <option value="study">Study Materials</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-participants">Participants</label>
                    <select id="expense-participants" multiple size="4">
                        <option value="" disabled>Select participants</option>
                    </select>
                    <small style="color:var(--secondary-color);">Hold Ctrl/Cmd to select multiple participants</small>
                </div>
                <div class="split-section" id="participant-shares-container">
                    <div class="split-header">
                        <div class="split-title">Split Expense</div>
                        <div class="split-toggle">
                            <span class="split-toggle-label">Equal Split</span>
                            <label class="switch">
                                <input type="checkbox" id="split-equally" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div id="split-error" class="split-error">Participant shares must sum to the total amount</div>
                    <div class="participant-shares-grid" id="participant-shares"></div>
                    <div class="split-summary" id="split-summary">Total: ‚Çπ0.00 | Remaining: ‚Çπ0.00</div>
                </div>
                <div class="form-group">
                    <label for="paid-by">Paid By</label>
                    <select id="paid-by" required>
                        <option value="">Select who paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="date-input">Date (dd-mm-yyyy)</label>
                    <input type="text" id="date-input" placeholder="dd-mm-yyyy" pattern="\d{2}-\d{2}-\d{4}" required>
                    <small style="display:block;margin-top:8px;color:var(--secondary-color);">Enter date as
                        dd-mm-yyyy</small>
                </div>
                <button type="submit" class="btn"><i class="fas fa-plus"></i> Add Expense</button>
            </form>
        </div>

        <div class="balance-section">
            <h2><i class="fas fa-scale-balanced"></i> Balance Sheet</h2>
            <div style="margin-bottom: 10px;">
                <button class="btn btn-small" onclick="window.debugRefreshBalances()"
                    style="font-size: 0.8rem; padding: 4px 8px;">
                    <i class="fas fa-refresh"></i> Refresh Balances
                </button>
            </div>
            <div id="balance-list">
                <div class="balance-item">
                    <span>No balances yet</span>
                    <span>‚Çπ0.00</span>
                </div>
            </div>
        </div>

        <div class="reports-section">
            <h2><i class="fas fa-chart-bar"></i> Reports</h2>
            <div class="tabs">
                <div class="tab active" data-tab="monthly">Monthly Breakdown</div>
                <div class="tab" data-tab="category">Category Analysis</div>
            </div>
            <div class="tab-content active" id="monthly-tab">
                <div class="chart-container">
                    <canvas id="monthly-chart"></canvas>
                </div>
            </div>
            <div class="tab-content" id="category-tab">
                <div class="chart-container">
                    <canvas id="category-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="category-summary">
            <h2><i class="fas fa-chart-pie"></i> Category Breakdown</h2>
            <div id="category-list">
                <div class="category-item">
                    <span>Food</span>
                    <span>‚Çπ 0.00</span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" style="width: 0%"></div>
                </div>
                <div class="category-item">
                    <span>Transport</span>
                    <span>‚Çπ 0.00</span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" style="width: 0%"></div>
                </div>
                <div class="category-item">
                    <span>Study Materials</span>
                    <span>‚Çπ 0.00</span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" style="width: 0%"></div>
                </div>
                <div class="category-item">
                    <span>Entertainment</span>
                    <span>‚Çπ 0.00</span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" style="width: 0%"></div>
                </div>
                <div class="category-item">
                    <span>Other</span>
                    <span>‚Çπ 0.00</span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="expense-list">
            <h2><i class="fas fa-history"></i> Recent Expenses</h2>
            <div style="margin-bottom:0.5rem;display:flex;gap:8px;">
                <button class="btn btn-small" id="download-csv"><i class="fas fa-file-csv"></i> Download CSV</button>
                <button class="btn btn-small" id="download-xlsx"><i class="fas fa-file-excel"></i> Export Excel</button>
            </div>
            <div id="expense-list">
                <div class="expense-item">
                    <div class="expense-details">
                        <strong>No expenses yet</strong>
                        <div>Add your first expense to see it here</div>
                    </div>
                    <div class="expense-actions">
                        <button class="btn btn-small" disabled><i class="fas fa-edit"></i></button>
                        <button class="btn btn-small btn-danger" disabled><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('confirm-modal')">&times;</span>
            <h2><i class="fas fa-exclamation-circle"></i> Confirm Action</h2>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <div class="modal-actions">
                <button class="btn btn-small" id="modal-confirm"><i class="fas fa-check"></i> Confirm</button>
                <button class="btn btn-small btn-danger" id="modal-cancel"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <div id="edit-expense-modal" class="modal">
        <div class="modal-content" style="max-width:520px;">
            <span class="close" onclick="closeModal('edit-expense-modal')">&times;</span>
            <h2 style="text-align:center;margin-bottom:1rem;"><i class="fas fa-edit"></i> Edit Expense</h2>
            <form id="edit-expense-form">
                <input type="hidden" name="_csrf" id="edit-csrf-token">
                <input type="hidden" id="edit-expense-id">
                <div class="form-group">
                    <label for="edit-expense-description">Description</label>
                    <input type="text" id="edit-expense-description" placeholder="Description" required>
                </div>
                <div class="form-group">
                    <label for="edit-expense-amount">Amount (‚Çπ)</label>
                    <input type="number" id="edit-expense-amount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-expense-category">Category</label>
                    <select id="edit-expense-category" required>
                        <option value="food">Food</option>
                        <option value="transport">Transport</option>
                        <option value="study">Study Materials</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-expense-date">Date (dd-mm-yyyy)</label>
                    <input type="text" id="edit-expense-date" placeholder="dd-mm-yyyy" pattern="\d{2}-\d{2}-\d{4}"
                        required>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                    <button type="button" class="btn btn-small btn-danger"
                        onclick="closeModal('edit-expense-modal')">Cancel</button>
                    <button type="submit" class="btn btn-small"><i class="fas fa-save"></i> Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-group-modal" class="modal">
        <div class="modal-content" style="max-width:420px;">
            <span class="close" onclick="closeModal('edit-group-modal')">&times;</span>
            <h2 style="text-align:center;margin-bottom:1rem;"><i class="fas fa-users-cog"></i> Edit Group</h2>
            <form id="edit-group-form">
                <input type="hidden" name="_csrf" id="edit-group-csrf-token">
                <input type="hidden" id="edit-group-id">
                <div class="form-group">
                    <label for="edit-group-name">Group Name</label>
                    <input type="text" id="edit-group-name" placeholder="Group name" required>
                </div>
                <div class="form-group">
                    <label>Group Code</label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input type="text" id="edit-group-code" readonly style="flex:1;">
                        <button type="button" class="btn btn-small" id="copy-code-btn"><i class="fas fa-copy"></i>
                            Copy</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                    <button type="button" class="btn btn-small btn-danger"
                        onclick="closeModal('edit-group-modal')">Cancel</button>
                    <button type="submit" class="btn btn-small"><i class="fas fa-save"></i> Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <span class="close" onclick="closeModal('profile-modal')">&times;</span>
            <h2 style="text-align:center;margin-bottom:1.5rem;"><i class="fas fa-user-edit"></i> Edit Profile</h2>
            <form id="profile-form">
                <input type="hidden" name="_csrf" id="profile-csrf-token">
                <div class="profile-upload-container">
                    <img id="profile-img-preview"
                        src="https://ui-avatars.com/api/?name=User&background=2563eb&color=fff" alt="Profile">
                    <label for="profile-img-input" class="upload-button"><i class="fas fa-upload"></i> Upload
                        Image</label>
                    <input type="file" id="profile-img-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="profile-name-input">Name</label>
                    <input type="text" id="profile-name-input" value="User" required>
                </div>
                <div class="form-group">
                    <label for="profile-email-input">Email</label>
                    <input type="email" id="profile-email-input" placeholder="you@yourdomain.com" required>
                </div>
                <div class="form-group">
                    <label for="profile-password-input">New Password</label>
                    <input type="password" id="profile-password-input" placeholder="Leave blank to keep unchanged">
                </div>
                <button type="submit" class="btn" style="width:100%;"><i class="fas fa-save"></i> Save Changes</button>
            </form>
        </div>
    </div>

    <div id="settle-debt-modal" class="modal">
        <div class="modal-content" style="max-width:550px;">
            <span class="close" onclick="closeModal('settle-debt-modal')">&times;</span>
            <h2 style="text-align:center;margin-bottom:1.5rem;"><i class="fas fa-handshake"></i> Settle Debt</h2>
            <form id="settle-debt-form">
                <input type="hidden" name="_csrf" id="settle-csrf-token">
                <input type="hidden" id="settle-debt-id">
                <div class="debt-info-card">
                    <div class="debt-header">
                        <div class="debt-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="debt-details">
                            <h3 id="settle-debt-title">Settle with User</h3>
                            <p id="settle-debt-details">You owe ‚Çπ0.00</p>
                        </div>
                        <div class="debt-amount">
                            <span id="settle-debt-amount">‚Çπ0.00</span>
                        </div>
                    </div>
                    <div class="debt-expense-info">
                        <small id="settle-expense-details">Related to: No specific expense</small>
                    </div>
                </div>
                <div class="settlement-form-section">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="settle-amount"><i class="fas fa-rupee-sign"></i> Settlement Amount</label>
                            <div class="input-with-currency">
                                <span class="currency-symbol">‚Çπ</span>
                                <input type="number" id="settle-amount" placeholder="0.00" step="0.01" min="0.01"
                                    required>
                            </div>
                            <small class="form-hint">Enter the amount you're paying</small>
                        </div>
                        <div class="form-group" style="width:120px;">
                            <button type="button" class="btn btn-small btn-outline" onclick="setFullAmount()"><i
                                    class="fas fa-coins"></i> Full Amount</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="settle-payment-method"><i class="fas fa-credit-card"></i> Payment Method</label>
                        <select id="settle-payment-method" required>
                            <option value="UPI">üí≥ UPI</option>
                            <option value="CASH">üíµ Cash</option>
                            <option value="BANK_TRANSFER">üè¶ Bank Transfer</option>
                            <option value="CARD">üí≥ Card</option>
                            <option value="OTHER">üì± Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="settle-description"><i class="fas fa-sticky-note"></i> Note (Optional)</label>
                        <textarea id="settle-description" placeholder="Add a note about this settlement..."
                            rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger btn-outline"
                        onclick="closeModal('settle-debt-modal')"><i class="fas fa-times"></i> Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-handshake"></i> Settle Debt</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reminder-modal" class="modal">
        <div class="modal-content reminder-modal">
            <span class="close" onclick="closeModal('reminder-modal')">&times;</span>
            <h2 style="text-align:center;margin-bottom:1.5rem;"><i class="fas fa-bell"></i> Send Payment Reminder</h2>
            <form id="reminder-form">
                <input type="hidden" name="_csrf" id="reminder-csrf-token">
                <input type="hidden" id="reminder-debtor-id">
                <div class="reminder-info">
                    <div class="icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="details">
                        <h3 id="reminder-title">Reminder for User</h3>
                        <p id="reminder-details">Outstanding amount: ‚Çπ0.00</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reminder-message"><i class="fas fa-comment"></i> Reminder Message</label>
                    <textarea id="reminder-message"
                        placeholder="Hey! Just a friendly reminder about the pending payment..." rows="4"
                        required></textarea>
                    <small class="form-hint">This message will be sent as a notification to the person who owes you
                        money</small>
                </div>
                <div class="form-group">
                    <label for="reminder-method"><i class="fas fa-paper-plane"></i> Reminder Method</label>
                    <select id="reminder-method" required>
                        <option value="IN_APP">üì± In-App Notification</option>
                        <option value="EMAIL">üìß Email (Future)</option>
                        <option value="SMS">üì± SMS (Future)</option>
                    </select>
                    <small class="form-hint">Currently, only in-app notifications are supported</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger btn-outline" onclick="closeModal('reminder-modal')"><i
                            class="fas fa-times"></i> Cancel</button>
                    <button type="submit" class="btn btn-warning"><i class="fas fa-bell"></i> Send Reminder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/dashboard.js"></script>
</body>

</html>